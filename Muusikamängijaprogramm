import tkinter as tk
import pygame
import os
import random
import time
import mutagen
import time
from tkinter import filedialog
from tkinter import *


#Kasutatud materjalid: https://www.youtube.com/watch?v=jO6qQDNa2UY
#https://www.pygame.org/docs/ref/mixer.html

pygame.mixer.init()
pygame.init()

Muusika_L√µpp = pygame.event.custom_type()
class UI:
    def __init__(self):
        pygame.mixer.music.set_endevent(Muusika_L√µpp)
        self.valmista_p√µhi()
    
    def valmista_p√µhi(self):
        
        self.root = tk.Tk()

        self.root.geometry("483x600")#kuldl√µige
        self.root.title("Muusika m√§ngija")
        
        self.playPause_nupp = tk.Button(self.root, text="‚èØ", font=("Impact", 18), command=self.playpause)
        self.playPause_nupp.pack(padx=10, pady=10)
        self.laulul√µpukontrollija = False
        self.musicOnPaused = False
        
        self.Fail_nupp = tk.Button(self.root, text="Fail", font=("Arial", 18), command=self.valifail)
        self.Fail_nupp.pack(padx= 10, pady=10)
        self.lauludej√§rjend = []
        self.hetkelm√§ngivalauluindeks = -1
        
        self.j√§rgminelaul_nupp = tk.Button(self.root, text="‚è≠", font=("Arial", 18), command=self.j√§rgminelaul)
        self.j√§rgminelaul_nupp.pack(padx = 10, pady=10)
        
        self.eelminelaul_nupp = tk.Button(self.root, text="‚èÆ", font=("Arial", 18), command=self.eelminelaul)
        self.eelminelaul_nupp.pack(padx = 10, pady=10)
        
        self.shuffle_nupp = tk.Button(self.root, text="üîÄ", font=("Arial", 18), command=self.shuffle)
        self.shuffle_nupp.pack(padx = 10, pady = 10)
        self.korra_juba_tehtud_shuffle = False
        
        self.vol√º√ºmslider = tk.Scale(self.root, from_=100, to=0, length=200, command=self.slider_v√§√§rtused)
        self.vol√º√ºmslider.set(100)
        self.vol√º√ºmslider.pack(padx = 10, pady = 10)
        self.lauluscrollslider = tk.Scale(self.root, from_=0, to = 100, orient=HORIZONTAL, length= 400, command=self.scrollilaulus)
        self.lauluscrollslider.pack(padx = 10, pady = 10)
        self.enne_scrollimist = 0.0
        
        self.hetke_aeg = Label(self.root, text = '', bd=1, anchor=E)
        self.hetke_aeg.pack()
        
        self.root.protocol("WM_DELETE_WINDOW", self.sulgemine)
        
        self.Event_Kontroll()
        
        self.root.mainloop()
    
    def Event_Kontroll(self):
        for event in pygame.event.get():
            if event.type == Muusika_L√µpp:
                self.j√§rgminelaul()
                
        self.Hetkeaeg_laulus = int(pygame.mixer.music.get_pos() / 1000 + self.enne_scrollimist)
        self.Hetkeaeg_laulus_kena_visuaalselt = time.strftime('%M:%S', time.gmtime(self.Hetkeaeg_laulus))
        self.hetke_aeg.config(text=self.Hetkeaeg_laulus_kena_visuaalselt)#Muudab graafilisel liidesel v√§√§rtust
        self.root.after(100, self.Event_Kontroll)  # Kontrolli uuesti 100ms p√§rast
        
    def playpause(self):
        if pygame.mixer.music.get_busy() == False:
            if self.musicOnPaused:
                pygame.mixer.music.unpause()
                self.musicOnPaused = False
            else:
                self.hetkelm√§ngivalauluindeks += 1
                pygame.mixer.music.load(self.lauludej√§rjend[self.hetkelm√§ngivalauluindeks])
                pygame.mixer.music.play()
                self.musict√∂√∂olek = True
        
        else:
            self.musict√∂√∂olek = False
            self.musicOnPaused = True
            pygame.mixer.music.pause()
            print(pygame.mixer.music.get_busy())

                    
    def valifail(self):
        self.failinimi = filedialog.askopenfilenames(title="Vailge helifail mida m√§ngida", initialdir=os.path.expanduser('~/music'), filetypes=[('Audio Files', '*.flac *.mp3 *.wav *.aac *.ogg *.wma *opus *.alac *.mid')])
        if self.failinimi == None:
            pass
        else:
            for i in self.failinimi: #https://www.geeksforgeeks.org/how-to-add-music-playlist-in-pygame/
                self.lauludej√§rjend.append(i)
    
    def j√§rgminelaul(self):
        if len(self.lauludej√§rjend) <= self.hetkelm√§ngivalauluindeks + 1:
            pass
        else:
            self.hetkelm√§ngivalauluindeks += 1
            pygame.mixer.music.load(self.lauludej√§rjend[self.hetkelm√§ngivalauluindeks])
            pygame.mixer.music.play()
            self.musict√∂√∂olek = True
            self.enne_scrollimist = 0.0
            
    def eelminelaul(self):
        if self.Hetkeaeg_laulus > 2:
            pygame.mixer.music.load(self.lauludej√§rjend[self.hetkelm√§ngivalauluindeks])
            pygame.mixer.music.play()
            self.enne_scrollimist = 0.0
        else:
            self.hetkelm√§ngivalauluindeks -= 1
            pygame.mixer.music.load(self.lauludej√§rjend[self.hetkelm√§ngivalauluindeks])
            pygame.mixer.music.play()
            self.enne_scrollimist = 0.0
    
    def shuffle(self):
        if self.korra_juba_tehtud_shuffle == False:
            self.originaalj√§rjend = self.lauludej√§rjend.copy()
            random.shuffle(self.lauludej√§rjend)
            self.korra_juba_tehtud_shuffle = True
            self.shufflet√∂√∂m√§√§raja = True
        elif self.shufflet√∂√∂m√§√§raja:
            self.lauludej√§rjend = self.originaalj√§rjend
        else:
            random.shuffle(self.lauludej√§rjend)
    
    def slider_v√§√§rtused(self, v√§√§rtus):
        pygame.mixer.music.set_volume(float(v√§√§rtus) / 100.0)
        
    def scrollilaulus(self, v√§√§rtus):
        #Leiab laulu pikkuse
        audio = mutagen.File(self.lauludej√§rjend[self.hetkelm√§ngivalauluindeks])
        try:
            laulupikkus = audio.info.length
        except:
            print("Ei leidnud laulupikkust")
        
        self.enne_scrollimist = float((float(v√§√§rtus)*laulupikkus)/100.0)
        #Laeb lauluuuesti ja m√§ngib vastavalt v√§√§rtusele valitud laulu kohast.
        pygame.mixer.music.load(self.lauludej√§rjend[self.hetkelm√§ngivalauluindeks])
        pygame.mixer.music.play(loops=0, start=self.enne_scrollimist)
    
    def sulgemine(self):
        pygame.mixer.quit() #https://www.pygame.org/docs/ref/mixer.html
        self.root.destroy()        

UI()
